<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XCRF Metrics Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #ddd6fe 100%);
            min-height: 100vh;
            padding: 24px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .info-box {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .info-box h2 {
            color: #92400e;
            font-size: 20px;
            margin-bottom: 16px;
        }
        
        .info-box ul {
            list-style: none;
        }
        
        .info-box li {
            color: #78350f;
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
            line-height: 1.6;
        }
        
        .info-box code {
            background: #fef3c7;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .main-card {
            background: white;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .header {
            margin-bottom: 24px;
        }
        
        .header h1 {
            color: #1f2937;
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 16px;
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .upload-box {
            border: 3px dashed #a5b4fc;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-box:hover {
            border-color: #6366f1;
            background: #f5f3ff;
        }
        
        .upload-box.past {
            border-color: #d8b4fe;
        }
        
        .upload-box.past:hover {
            border-color: #a855f7;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .upload-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .upload-text {
            color: #6b7280;
            font-size: 14px;
        }
        
        .file-name {
            color: #10b981;
            font-size: 14px;
            margin-top: 8px;
        }
        
        .analyze-btn {
            width: 100%;
            background: #4f46e5;
            color: white;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .analyze-btn:hover:not(:disabled) {
            background: #4338ca;
        }
        
        .analyze-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-label {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .summary-value {
            font-size: 36px;
            font-weight: 700;
        }
        
        .summary-value.total {
            color: #4f46e5;
        }
        
        .summary-value.present {
            color: #10b981;
        }
        
        .summary-value.past {
            color: #a855f7;
        }
        
        .results-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .results-section h2 {
            font-size: 24px;
            color: #1f2937;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead tr {
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
        }
        
        th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
        }
        
        th.center {
            text-align: center;
        }
        
        tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s;
            cursor: pointer;
        }
        
        tbody tr:hover {
            background: #f9fafb;
        }
        
        tbody tr.expanded {
            background: #eff6ff;
        }
        
        td {
            padding: 16px;
            color: #1f2937;
        }
        
        td.center {
            text-align: center;
        }
        
        td.clickable {
            color: #4f46e5;
            font-weight: 600;
            cursor: pointer;
        }
        
        td.clickable:hover {
            color: #4338ca;
            text-decoration: underline;
        }
        
        .total-count {
            font-weight: 600;
            color: #4f46e5;
        }
        
        .present-count {
            color: #10b981;
        }
        
        .past-count {
            color: #a855f7;
        }
        
        .details-row {
            display: none;
        }
        
        .details-row.show {
            display: table-row;
        }
        
        .details-cell {
            padding: 0 !important;
            background: #eff6ff;
        }
        
        .details-content {
            padding: 24px;
            background: #f8fafc;
            border-left: 4px solid #4f46e5;
        }
        
        .details-header {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
        }

        /* Added style for the new button */
        .all-tickets-btn {
            background: #4f46e5;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none; /* Make it look like a button but act like a link */
            display: inline-block;
            margin-bottom: 16px;
            margin-right: 12px; /* Added spacing */
        }

        .all-tickets-btn:hover {
            background: #4338ca;
        }
        /* End of added style */
        
        .ticket-list {
            display: grid;
            gap: 12px;
        }
        
        .ticket-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border-left: 3px solid #4f46e5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .ticket-key {
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .ticket-key a {
            color: #4f46e5;
            text-decoration: none;
        }
        
        .ticket-key a:hover {
            text-decoration: underline;
        }
        
        .ticket-summary {
            color: #374151;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .ticket-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .status-open {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-in-progress {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-done {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-code-review {
            background: #e9d5ff;
            color: #6b21a8;
        }
        
        .hidden {
            display: none;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .expand-icon {
            margin-right: 8px;
            transition: transform 0.3s;
        }
        
        .expand-icon.rotated {
            transform: rotate(90deg);
        }
        
        .breakdown-grid { /* Used for both Module and Status breakdown */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
            margin-bottom: 24px;
        }

        .module-badge { /* New style for module breakdown */
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
            background: #ecfdf5; /* Light green/teal */
            color: #047857; /* Darker green/teal */
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .status-badge {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .status-badge:hover, .module-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            margin: 20px;
            padding: 32px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 16px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .close-btn {
            font-size: 32px;
            font-weight: 700;
            color: #6b7280;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="info-box">
            <h2>‚öôÔ∏è XLS/CSV Export & Upload Instructions</h2>
            <ul>
                <li>
                    <span style="font-weight: 600; min-width: 20px;">1.</span>
                    <span>Due to web browser security restrictions, the Jira CSV file must be downloaded and then uploaded manually.</span>
                </li>
                <li>
                    <span style="font-weight: 600; min-width: 20px;">2.</span>
                    <span>Access Dashboard: Go to the Jira Dashboard: <a href="https://toasttab.atlassian.net/jira/dashboards/18638" target="_blank" style="color: #4f46e5; text-decoration: underline;">View Dashboard</a></span>
                </li>
                <li>
                    <span style="font-weight: 600; min-width: 20px;">3.</span>
                    <span>Export Data: Drill down on the "All Modules" count for the required week &rarr; click "Open all in Jira Issue Navigator" &rarr; then Export &rarr; Export CSV (my defaults).</span>
                </li>
                <li>
                    <span style="font-weight: 600; min-width: 20px;">4.</span>
                    <span>Required Columns: Ensure the exported file includes: <code>Assignee</code>, <code>Toast Team</code>, <code>Key</code>, <code>Summary</code>, <code>Status</code>, <code>Module</code>, and <code>Module/Category</code>.</span>
                </li>
                <li>
                    <span style="font-weight: 600; min-width: 20px;">5.</span>
                    <span>Upload: After downloading, manually click the upload boxes below to proceed.</span>
                </li>
            </ul>
        </div>

        <div class="main-card">
            <div class="header">
                <h1>üìä XCRF Metrics Tracker</h1>
                <p>Upload Excel/CSV files to analyze tickets by assignees and teams</p>
            </div>

            <div class="upload-grid">
                <label for="presentWeekFile" class="upload-box">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-title">Present Week</div>
                    <div class="upload-text" id="presentWeekText">Click to upload XLS/CSV</div>
                    <div class="file-name hidden" id="presentWeekFileName"></div>
                </label>
                <input type="file" id="presentWeekFile" accept=".xlsx,.xls,.csv">

                <label for="pastWeekFile" class="upload-box past">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-title">Past Week</div>
                    <div class="upload-text" id="pastWeekText">Click to upload XLS/CSV</div>
                    <div class="file-name hidden" id="pastWeekFileName"></div>
                </label>
                <input type="file" id="pastWeekFile" accept=".xlsx,.xls,.csv">
            </div>

            <button class="analyze-btn" id="analyzeBtn" disabled>Generate Analysis</button>
        </div>

        <div id="resultsContainer" class="hidden">
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">Total Tickets</div>
                    <div class="summary-value total" id="totalTickets">0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Present Week</div>
                    <div class="summary-value present" id="presentWeekTotal">0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Past Week</div>
                    <div class="summary-value past" id="pastWeekTotal">0</div>
                </div>
            </div>

            <div class="results-section">
                <h2>üè¢ Analysis by Toast Team</h2>
                <div id="teamSummary" style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0ea5e9;">
                    <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 12px; font-size: 16px;">Team Summary:</div>
                    <div id="teamSummaryContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;"></div>
                </div>
                <table id="teamTable">
                    <thead>
                        <tr>
                            <th>Toast Team</th>
                            <th class="center">Total</th>
                            <th class="center">Present Week</th>
                            <th class="center">Past Week</th>
                        </tr>
                    </thead>
                    <tbody id="teamTableBody">
                                        </tbody>
                </table>
            </div>

            <div class="results-section">
                <h2>üë• Analysis by Assignee</h2>
                <table id="assigneeTable">
                    <thead>
                        <tr>
                            <th>Assignee</th>
                            <th class="center">Total</th>
                            <th class="center">Present Week</th>
                            <th class="center">Past Week</th>
                        </tr>
                    </thead>
                    <tbody id="assigneeTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody" class="ticket-list"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let presentWeekData = null;
        let pastWeekData = null;
        let allTicketsData = [];

        window.addEventListener('load', function() {
            document.getElementById('presentWeekFile').addEventListener('change', function(e) {
                handleFileUpload(e.target.files[0], 'present');
            });

            document.getElementById('pastWeekFile').addEventListener('change', function(e) {
                handleFileUpload(e.target.files[0], 'past');
            });

            document.getElementById('analyzeBtn').addEventListener('click', analyzeData);
        });

        function handleFileUpload(file, weekType) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (weekType === 'present') {
                        presentWeekData = jsonData;
                        document.getElementById('presentWeekText').classList.add('hidden');
                        document.getElementById('presentWeekFileName').classList.remove('hidden');
                        document.getElementById('presentWeekFileName').innerHTML = `üìÑ ${file.name}`;
                    } else {
                        pastWeekData = jsonData;
                        document.getElementById('pastWeekText').classList.add('hidden');
                        document.getElementById('pastWeekFileName').classList.remove('hidden');
                        document.getElementById('pastWeekFileName').innerHTML = `üìÑ ${file.name}`;
                    }

                    if (presentWeekData || pastWeekData) {
                        document.getElementById('analyzeBtn').disabled = false;
                    }

                    document.getElementById('resultsContainer').classList.add('hidden');
                } catch (error) {
                    alert('Error parsing file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function getStatusClass(status) {
            if (!status) return 'status-open';
            const s = status.toLowerCase().replace(/\s+/g, '-');
            if (s.includes('done') || s.includes('closed')) return 'status-done';
            if (s.includes('progress') || s.includes('development')) return 'status-in-progress';
            if (s.includes('review')) return 'status-code-review';
            return 'status-open';
        }

        function createJiraLink(key) {
            if (!key) return '';
            return `https://toasttab.atlassian.net/browse/${key}`;
        }
        
        function createJiraAllTicketsLink(tickets) {
            const keys = tickets.map(ticket => {
                // Try multiple possible column names for Key
                return ticket.Key || ticket.key || ticket['Issue key'] || ticket['Issue Key'] || 
                       ticket.IssueKey || ticket.issuekey || ticket.T;
            }).filter(key => key); // Filter out null/undefined/empty keys

            if (keys.length === 0) return '#';

            // Construct JQL with a single newline character (\n)
            const jqlQuery = `key in (${keys.join(', ')})\nORDER BY assignee ASC`;
            
            // Encode the JQL query for a URL
            const encodedJql = encodeURIComponent(jqlQuery);

            // Construct the final Jira URL
            const baseUrl = 'https://toasttab.atlassian.net/issues/';
            return `${baseUrl}?jql=${encodedJql}`;
        }

        // Helper function to get Module name (UPDATED for better column header tolerance)
        function getModuleName(ticket) {
            const possibleModuleKeys = [
                'Module',
                'module',
                'Module/Category',
                'Module Category',
                'Custom field (Module)',
                'Custom field (Module/Category)',
            ];

            for (const key of possibleModuleKeys) {
                const value = ticket[key];
                if (value !== undefined && value !== null && String(value).trim() !== '') {
                    return String(value).trim();
                }
            }
            
            return 'Unknown Module';
        }

        function analyzeData() {
            if (!presentWeekData && !pastWeekData) {
                alert('Please upload at least one file');
                return;
            }

            allTicketsData = [
                ...(presentWeekData || []).map(item => ({ ...item, source: 'Present Week' })),
                ...(pastWeekData || []).map(item => ({ ...item, source: 'Past Week' }))
            ];

            // Group by Assignee (no change)
            const byAssignee = {};
            allTicketsData.forEach(ticket => {
                const assignee = ticket.Assignee || 'Unassigned';
                if (!byAssignee[assignee]) {
                    byAssignee[assignee] = { total: 0, presentWeek: 0, pastWeek: 0, tickets: [] };
                }
                byAssignee[assignee].total++;
                byAssignee[assignee].tickets.push(ticket);
                if (ticket.source === 'Present Week') {
                    byAssignee[assignee].presentWeek++;
                } else {
                    byAssignee[assignee].pastWeek++;
                }
            });

            // Group by Toast Team with status and module breakdown (MODIFIED)
            const byTeam = {};
            allTicketsData.forEach(ticket => {
                // Try different column name variations for Toast Team
                let team = ticket['Toast Team'] || ticket.ToastTeam || ticket['Toast_Team'] || 
                            ticket['Custom field (Toast Team)'] || ticket['Team'] || 'Others';
                
                // Consolidate teams into categories
                if (team.includes('Inventory and Recipe') || team.includes('Item Data Domain')) {
                    team = 'XC PRO';
                } else if (team.includes('Accounting')) {
                    team = 'S&A: Accounting';
                } else if (team.includes('Invoicing') || team.includes('OCR')) {
                    team = 'S&A: Invoicing(OCR)';
                } else if (team !== 'S&A: Accounting' && team !== 'S&A: Invoicing(OCR)' && team !== 'XC PRO' && team !== 'No Team') {
                    // Any other team goes to Others
                    if (!team.startsWith('S&A:')) {
                        team = 'Others';
                    }
                }
                
                if (!byTeam[team]) {
                    byTeam[team] = { 
                        total: 0, 
                        presentWeek: 0, 
                        pastWeek: 0, 
                        tickets: [],
                        statusBreakdown: {},
                        statusTickets: {}, // Store tickets by status
                        moduleBreakdown: {}, // NEW: Store count by module
                        moduleTickets: {} // NEW: Store tickets by module
                    };
                }
                byTeam[team].total++;
                byTeam[team].tickets.push(ticket);
                
                const status = ticket.Status || 'Unknown';
                byTeam[team].statusBreakdown[status] = (byTeam[team].statusBreakdown[status] || 0) + 1;
                
                // Group tickets by status
                if (!byTeam[team].statusTickets[status]) {
                    byTeam[team].statusTickets[status] = [];
                }
                byTeam[team].statusTickets[status].push(ticket);

                // --- NEW MODULE LOGIC ---
                const moduleName = getModuleName(ticket);
                byTeam[team].moduleBreakdown[moduleName] = (byTeam[team].moduleBreakdown[moduleName] || 0) + 1;
                
                // Group tickets by module
                if (!byTeam[team].moduleTickets[moduleName]) {
                    byTeam[team].moduleTickets[moduleName] = [];
                }
                byTeam[team].moduleTickets[moduleName].push(ticket);
                // ------------------------
                
                if (ticket.source === 'Present Week') {
                    byTeam[team].presentWeek++;
                } else {
                    byTeam[team].pastWeek++;
                }
            });

            // Update summary
            document.getElementById('totalTickets').textContent = allTicketsData.length;
            document.getElementById('presentWeekTotal').textContent = presentWeekData?.length || 0;
            document.getElementById('pastWeekTotal').textContent = pastWeekData?.length || 0;

            // Populate assignee table (no change)
            const assigneeTableBody = document.getElementById('assigneeTableBody');
            assigneeTableBody.innerHTML = '';
            Object.entries(byAssignee)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([assignee, data], index) => {
                    const rowId = `assignee-${index}`;
                    const detailsId = `details-${index}`;
                    
                    const row = document.createElement('tr');
                    row.id = rowId;
                    row.innerHTML = `
                        <td><span class="expand-icon">‚ñ∂</span><strong>${assignee}</strong></td>
                        <td class="center total-count clickable">${data.total}</td>
                        <td class="center present-count">${data.presentWeek}</td>
                        <td class="center past-count">${data.pastWeek}</td>
                    `;
                    row.onclick = () => toggleDetails(rowId, detailsId, data.tickets);
                    assigneeTableBody.appendChild(row);

                    const detailsRow = document.createElement('tr');
                    detailsRow.id = detailsId;
                    detailsRow.className = 'details-row';
                    detailsRow.innerHTML = `
                        <td colspan="4" class="details-cell">
                            <div class="details-content">
                                <div class="details-header">Tickets for ${assignee}</div>
                                <div class="ticket-list" id="tickets-${index}"></div>
                            </div>
                        </td>
                    `;
                    assigneeTableBody.appendChild(detailsRow);
                });

            // Populate team table (MODIFIED detailsRow.innerHTML)
            const teamTableBody = document.getElementById('teamTableBody');
            teamTableBody.innerHTML = '';
            
            // Create team summary
            const teamSummaryContent = document.getElementById('teamSummaryContent');
            teamSummaryContent.innerHTML = '';
            
            Object.entries(byTeam)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([team, data]) => {
                    // Add to summary
                    const summaryItem = document.createElement('div');
                    summaryItem.style.cssText = 'background: white; padding: 12px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);';
                    summaryItem.innerHTML = `
                        <div style="font-weight: 600; color: #1f2937; font-size: 14px;">${team}</div>
                        <div style="font-size: 24px; font-weight: 700; color: #0ea5e9; margin-top: 4px;">${data.total}</div>
                    `;
                    teamSummaryContent.appendChild(summaryItem);
                });
            
            // Add table rows
            Object.entries(byTeam)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([team, data], index) => {
                    const rowId = `team-${index}`;
                    const detailsId = `team-details-${index}`;
                    
                    const row = document.createElement('tr');
                    row.id = rowId;
                    row.innerHTML = `
                        <td><span class="expand-icon">‚ñ∂</span><strong>${team}</strong></td>
                        <td class="center total-count clickable">${data.total}</td>
                        <td class="center present-count">${data.presentWeek}</td>
                        <td class="center past-count">${data.pastWeek}</td>
                    `;
                    row.onclick = () => toggleTeamDetails(rowId, detailsId, data);
                    teamTableBody.appendChild(row);

                    const detailsRow = document.createElement('tr');
                    detailsRow.id = detailsId;
                    detailsRow.className = 'details-row';
                    // The innerHTML is updated to include module breakdown container
                    detailsRow.innerHTML = `
                        <td colspan="4" class="details-cell">
                            <div class="details-content">
                                <div class="details-header">Module Breakdown for ${team}</div>
                                <div class="breakdown-grid" id="module-${index}"></div> <div class="details-header" style="margin-top: 24px;">Status Breakdown for ${team}</div>
                                <div class="breakdown-grid" id="status-${index}"></div>
                                
                                <a href="#" target="_blank" id="allTicketsLink-${index}" class="all-tickets-btn">All tickets (${data.total})</a>
                                <div class="ticket-list" id="team-tickets-${index}"></div>
                            </div>
                        </td>
                    `;
                    teamTableBody.appendChild(detailsRow);
                });

            document.getElementById('resultsContainer').classList.remove('hidden');
            document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function toggleDetails(rowId, detailsId, tickets) {
            const row = document.getElementById(rowId);
            const detailsRow = document.getElementById(detailsId);
            const icon = row.querySelector('.expand-icon');
            
            if (detailsRow.classList.contains('show')) {
                detailsRow.classList.remove('show');
                row.classList.remove('expanded');
                icon.classList.remove('rotated');
            } else {
                detailsRow.classList.add('show');
                row.classList.add('expanded');
                icon.classList.add('rotated');
                
                const ticketListId = detailsRow.querySelector('.ticket-list').id;
                const ticketList = document.getElementById(ticketListId);
                ticketList.innerHTML = '';
                
                tickets.forEach(ticket => {
                    // Try multiple possible column names for Key
                    const key = ticket.Key || ticket.key || ticket['Issue key'] || ticket['Issue Key'] || 
                               ticket.IssueKey || ticket.issuekey || ticket.T || 'N/A';
                    const summary = ticket.Summary || ticket.summary || ticket.Description || 
                                  ticket.description || 'No summary available';
                    const status = ticket.Status || ticket.status || 'Unknown';
                    const link = createJiraLink(key);
                    
                    const ticketDiv = document.createElement('div');
                    ticketDiv.className = 'ticket-item';
                    ticketDiv.innerHTML = `
                        <div class="ticket-key">
                            ${key !== 'N/A' ? `<a href="${link}" target="_blank">${key}</a>` : key}
                        </div>
                        <div class="ticket-summary">${summary}</div>
                        <span class="ticket-status ${getStatusClass(status)}">${status}</span>
                    `;
                    ticketList.appendChild(ticketDiv);
                });
            }
        }

        function toggleTeamDetails(rowId, detailsId, data) {
            const row = document.getElementById(rowId);
            const detailsRow = document.getElementById(detailsId);
            const icon = row.querySelector('.expand-icon');
            
            if (detailsRow.classList.contains('show')) {
                detailsRow.classList.remove('show');
                row.classList.remove('expanded');
                icon.classList.remove('rotated');
            } else {
                detailsRow.classList.add('show');
                row.classList.add('expanded');
                icon.classList.add('rotated');
                
                const index = detailsId.split('-').pop(); 

                // Update the All Tickets link
                const allTicketsLinkElement = document.getElementById(`allTicketsLink-${index}`);
                if (allTicketsLinkElement) {
                    const jiraUrl = createJiraAllTicketsLink(data.tickets);
                    allTicketsLinkElement.href = jiraUrl;
                    allTicketsLinkElement.textContent = `All tickets (${data.total})`;
                }
                
                // --- NEW CODE: Render module breakdown ---
                const moduleBreakdownId = detailsRow.querySelector('#module-' + index).id;
                const moduleContainer = document.getElementById(moduleBreakdownId);
                moduleContainer.innerHTML = '';
                
                Object.entries(data.moduleBreakdown)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([moduleName, count]) => {
                        const badge = document.createElement('div');
                        badge.className = `module-badge`;
                        badge.style.cursor = 'pointer';
                        badge.innerHTML = `<strong>${moduleName}</strong><br>${count} ticket${count !== 1 ? 's' : ''}`;
                        badge.onclick = (e) => {
                            e.stopPropagation();
                            showStatusTickets(moduleName, data.moduleTickets[moduleName], 'Module'); // Reusing showStatusTickets
                        };
                        moduleContainer.appendChild(badge);
                    });
                // ------------------------------------------

                // Render status breakdown (existing logic)
                const statusBreakdownId = detailsRow.querySelector('#status-' + index).id;
                const statusContainer = document.getElementById(statusBreakdownId);
                statusContainer.innerHTML = '';
                
                Object.entries(data.statusBreakdown)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([status, count]) => {
                        const badge = document.createElement('div');
                        badge.className = `status-badge ${getStatusClass(status)}`;
                        badge.style.cursor = 'pointer';
                        badge.innerHTML = `<strong>${status}</strong><br>${count} ticket${count !== 1 ? 's' : ''}`;
                        badge.onclick = (e) => {
                            e.stopPropagation();
                            showStatusTickets(status, data.statusTickets[status], 'Status');
                        };
                        statusContainer.appendChild(badge);
                    });
                
                // Render tickets (existing logic)
                const ticketListId = detailsRow.querySelector('.ticket-list').id;
                const ticketList = document.getElementById(ticketListId);
                ticketList.innerHTML = '';
                
                data.tickets.forEach(ticket => {
                    // Try multiple possible column names for Key
                    const key = ticket.Key || ticket.key || ticket['Issue key'] || ticket['Issue Key'] || 
                               ticket.IssueKey || ticket.issuekey || ticket.T || 'N/A';
                    const summary = ticket.Summary || ticket.summary || ticket.Description || 
                                  ticket.description || 'No summary available';
                    const status = ticket.Status || ticket.status || 'Unknown';
                    const assignee = ticket.Assignee || 'Unassigned';
                    const link = createJiraLink(key);
                    
                    const ticketDiv = document.createElement('div');
                    ticketDiv.className = 'ticket-item';
                    ticketDiv.innerHTML = `
                        <div class="ticket-key">
                            ${key !== 'N/A' ? `<a href="${link}" target="_blank">${key}</a>` : key} - ${assignee}
                        </div>
                        <div class="ticket-summary">${summary}</div>
                        <span class="ticket-status ${getStatusClass(status)}">${status}</span>
                    `;
                    ticketList.appendChild(ticketDiv);
                });
            }
        }
        
        function showStatusTickets(typeValue, tickets, breakdownType = 'Status') {
            const modal = document.getElementById('statusModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `${typeValue} (${breakdownType}) - ${tickets.length} Ticket${tickets.length !== 1 ? 's' : ''}`;
            modalBody.innerHTML = '';
            
            tickets.forEach(ticket => {
                const key = ticket.Key || ticket.key || ticket['Issue key'] || ticket['Issue Key'] || 
                           ticket.IssueKey || ticket.issuekey || ticket.T || 'N/A';
                const summary = ticket.Summary || ticket.summary || ticket.Description || 
                              ticket.description || 'No summary available';
                const status = ticket.Status || ticket.status || 'Unknown';
                const assignee = ticket.Assignee || 'Unassigned';
                const link = createJiraLink(key);
                
                const ticketDiv = document.createElement('div');
                ticketDiv.className = 'ticket-item';
                ticketDiv.innerHTML = `
                    <div class="ticket-key">
                        ${key !== 'N/A' ? `<a href="${link}" target="_blank">${key}</a>` : key} - ${assignee}
                    </div>
                    <div class="ticket-summary">${summary}</div>
                    <span class="ticket-status ${getStatusClass(status)}">${status}</span>
                `;
                modalBody.appendChild(ticketDiv);
            });
            
            modal.classList.add('show');
        }
        
        function closeModal() {
            const modal = document.getElementById('statusModal');
            modal.classList.remove('show');
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('statusModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>

